<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Progress ‚Äî Hive</title>
    <link rel="stylesheet" href="/static/css/navbar.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #f59e0b;
            --primary-dark: #d97706;
            --secondary-color: #10b981;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --white: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica', 'Arial', sans-serif;
            color: var(--text-dark);
            background: var(--bg-light);
            line-height: 1.6;
        }

        .status-container {
            max-width: 1100px;
            margin: 2.5rem auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            min-height: calc(100vh - 140px);
        }

        .status-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        .status-selected {
            background: #d1fae5;
            color: #065f46;
        }

        .status-scheduled {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-in_progress {
            background: #e0e7ff;
            color: #3730a3;
        }

        .status-awaiting_confirmation {
            background: #fce7f3;
            color: #9f1239;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Progress Stepper */
        .progress-stepper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
            padding: 0 1rem;
        }

        .progress-stepper::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e5e7eb;
            z-index: 0;
        }

        .stepper-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            flex: 1;
            max-width: 120px;
        }

        .stepper-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .stepper-item.active .stepper-circle {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .stepper-item.completed .stepper-circle {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .stepper-label {
            font-size: 0.75rem;
            text-align: center;
            color: #9ca3af;
            font-weight: 500;
            line-height: 1.2;
        }

        .stepper-item.active .stepper-label {
            color: var(--text-dark);
            font-weight: 700;
        }

        .stepper-item.completed .stepper-label {
            color: #10b981;
            font-weight: 600;
        }

        .stepper-date {
            font-size: 0.625rem;
            color: #6b7280;
            text-align: center;
            margin-top: 0.25rem;
            line-height: 1.2;
        }

        .alert-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .alert-box.success {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .alert-box.info {
            background: #dbeafe;
            border-left-color: #3b82f6;
        }

        .consumer-info {
            background: var(--bg-light);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .consumer-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .consumer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }

        .consumer-details {
            flex: 1;
        }

        .consumer-name {
            font-weight: 700;
            font-size: 1.125rem;
        }

        .message-thread {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
            max-width: 70%;
        }

        .message.current-user {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message.other-user {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message.current-user .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.other-user .message-content {
            background: var(--bg-light);
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            color: var(--text-light);
        }

        .message-text {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .message-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .message-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .sidebar-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: none;
            height: fit-content;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }

        .info-label {
            color: var(--text-light);
        }

        .info-value {
            font-weight: 600;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9375rem;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-dark);
            border: 1px solid #d1d5db;
        }

        .btn-ghost:hover {
            background: var(--bg-light);
        }

        .service-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .service-meta {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .tag {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            background: #e0e7ff;
            color: #3730a3;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        @media (max-width: 900px) {
            .status-container { 
                grid-template-columns: 1fr; 
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="/" class="logo">
                <img src="/static/hive_logo.png" alt="Hive Logo" style="height: 40px; width: auto;">
                <span>Hive</span>
            </a>
            <div id="nav-buttons">
                <!-- Navigation will be dynamically loaded -->
            </div>
        </div>
    </nav>

    <main class="status-container">
        <section>
            <!-- Progress Stepper -->
            <div class="status-card">
                <div class="progress-stepper" id="progressStepper">
                    <!-- Stepper will be populated by JavaScript -->
                </div>
            </div>

            <!-- Status Alert -->
            <div id="statusAlert" class="alert-box">
                <strong>Loading...</strong>
            </div>

            <!-- Messages Section -->
            <div class="status-card">
                <h3 style="margin-bottom: 1rem;">üí¨ Messages with Consumer</h3>
                
                <div class="consumer-info" id="consumerInfo">
                    <!-- Consumer info will be populated -->
                </div>

                <div class="message-thread" id="messageThread">
                    <!-- Messages will be loaded here -->
                </div>

                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Type your message..." />
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </section>

        <!-- Sidebar -->
        <aside>
            <div class="sidebar-card">
                <h3 style="margin-bottom: 1rem;">Progress Status</h3>
                
                <div class="info-row">
                    <span class="info-label">Status</span>
                    <span class="info-value" id="sidebarStatus">Loading...</span>
                </div>

                <div class="info-row">
                    <span class="info-label">Applied On</span>
                    <span class="info-value" id="appliedDate">-</span>
                </div>

                <div class="info-row" id="scheduledDateRow" style="display:none;">
                    <span class="info-label">Scheduled Date</span>
                    <span class="info-value" id="scheduledDate">-</span>
                </div>

                <div class="info-row" id="scheduledTimeRow" style="display:none;">
                    <span class="info-label">Scheduled Time</span>
                    <span class="info-value" id="scheduledTime">-</span>
                </div>

                <hr style="margin: 1rem 0; border: none; border-top: 1px solid #e5e7eb;">

                <h3 style="margin-bottom: 1rem;">Service Details</h3>

                <div class="info-row">
                    <span class="info-label">Estimated Hours</span>
                    <span class="info-value" id="estimatedHours">-</span>
                </div>

                <div class="info-row">
                    <span class="info-label">Location</span>
                    <span class="info-value" id="locationDistance">-</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="sidebar-card" id="actionButtons" style="margin-top: 1rem;">
                <!-- Dynamic buttons will be shown based on status -->
            </div>

            <!-- Service Details Card -->
            <div class="sidebar-card" id="serviceDetailsCard" style="margin-top: 1rem; background: white; padding: 1.5rem;">
                <!-- Service details will be populated -->
            </div>
        </aside>
    </main>

    <script>
        const APPLICATION_ID = new URLSearchParams(window.location.search).get('application_id');
        let currentProgress = null;
        let currentApplication = null;
        let currentService = null;
        let otherUser = null;

        async function loadProgressData() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = '/signin';
                    return;
                }

                // Get progress data
                const progressResponse = await fetch(`/api/applications/${APPLICATION_ID}/progress`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!progressResponse.ok) {
                    throw new Error('Failed to load progress');
                }

                const progressData = await progressResponse.json();
                currentProgress = progressData.progress;
                currentApplication = progressData.application;
                currentService = progressData.service;
                otherUser = progressData.other_user;

                renderProgressStepper();
                renderStatusAlert();
                renderConsumerInfo();
                renderSidebarInfo();
                renderActionButtons();
                renderServiceDetails();
                loadMessages();

            } catch (error) {
                console.error('Error loading progress:', error);
                document.getElementById('statusAlert').innerHTML = 
                    '<strong>Error</strong><p style="margin-top: 0.5rem; font-size: 0.875rem;">Failed to load progress data.</p>';
            }
        }

        function renderProgressStepper() {
            const stepper = document.getElementById('progressStepper');
            const steps = [
                { id: 'selected', label: 'Selected', number: 1, date: currentProgress.selected_at },
                { id: 'scheduled', label: 'Scheduled', number: 2, date: currentProgress.scheduled_at },
                { id: 'in_progress', label: 'In Progress', number: 3, date: currentProgress.started_at },
                { id: 'awaiting_confirmation', label: 'Confirmation', number: 4, date: null },
                { id: 'completed', label: 'Completed', number: 5, date: currentProgress.completed_at }
            ];

            const statusOrder = ['selected', 'scheduled', 'in_progress', 'awaiting_confirmation', 'completed'];
            const currentIndex = statusOrder.indexOf(currentProgress.status);

            stepper.innerHTML = steps.map((step, index) => {
                let className = 'stepper-item';
                let circleContent = step.number;
                
                if (index < currentIndex) {
                    className += ' completed';
                    circleContent = '‚úì';
                } else if (index === currentIndex) {
                    className += ' active';
                }

                const dateStr = step.date ? new Date(step.date).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                }) : '';

                return `
                    <div class="${className}">
                        <div class="stepper-circle">${circleContent}</div>
                        <div class="stepper-label">${step.label}</div>
                        ${dateStr ? `<div class="stepper-date">${dateStr}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderStatusAlert() {
            const alert = document.getElementById('statusAlert');
            const statusMessages = {
                'selected': {
                    class: 'info',
                    title: 'üìÖ Application Selected',
                    text: 'Schedule a date and time for this service with the consumer.'
                },
                'scheduled': {
                    class: 'info',
                    title: '‚è∞ Service Scheduled',
                    text: `Service scheduled for ${formatDate(currentProgress.scheduled_date)} at ${currentProgress.scheduled_time}. Mark as "In Progress" when you start.`
                },
                'in_progress': {
                    class: 'info',
                    title: 'üîß Service In Progress',
                    text: 'Complete the service and mark it as done when finished.'
                },
                'awaiting_confirmation': {
                    class: 'info',
                    title: '‚è∞ Awaiting Consumer Confirmation',
                    text: 'Waiting for the consumer to confirm completion.'
                },
                'completed': {
                    class: 'success',
                    title: '‚úÖ Service Completed!',
                    text: `${currentProgress.hours} hours have been deducted from your account.`
                }
            };

            const msg = statusMessages[currentProgress.status];
            alert.className = `alert-box ${msg.class}`;
            alert.innerHTML = `<strong>${msg.title}</strong><p style="margin-top: 0.5rem; font-size: 0.875rem;">${msg.text}</p>`;
        }

        function renderConsumerInfo() {
            const container = document.getElementById('consumerInfo');
            const initials = otherUser.full_name ? 
                otherUser.full_name.split(' ').map(n => n[0]).join('').toUpperCase() : 
                otherUser.email[0].toUpperCase();

            container.innerHTML = `
                <div class="consumer-header">
                    <div class="consumer-avatar">${initials}</div>
                    <div class="consumer-details">
                        <div class="consumer-name">${otherUser.full_name || otherUser.email}</div>
                    </div>
                    <button class="btn btn-ghost" onclick="window.location.href='/user/${otherUser.id}'">View Profile</button>
                </div>
            `;
        }

        function renderSidebarInfo() {
            document.getElementById('sidebarStatus').textContent = formatStatus(currentProgress.status);
            document.getElementById('appliedDate').textContent = formatDate(currentApplication.applied_at);
            document.getElementById('estimatedHours').textContent = `${currentProgress.hours} hrs`;
            
            // Show the service location if available (should not typically have location for offers)
            const location = currentProgress.agreed_location || 'Not specified';
            document.getElementById('locationDistance').textContent = location;

            if (currentProgress.scheduled_date) {
                document.getElementById('scheduledDateRow').style.display = 'flex';
                document.getElementById('scheduledDate').textContent = formatDate(currentProgress.scheduled_date);
            }

            if (currentProgress.scheduled_time) {
                document.getElementById('scheduledTimeRow').style.display = 'flex';
                document.getElementById('scheduledTime').textContent = currentProgress.scheduled_time;
            }
        }

        function renderActionButtons() {
            const container = document.getElementById('actionButtons');
            let buttons = '';

            switch(currentProgress.status) {
                case 'selected':
                    buttons = `
                        <button class="btn btn-primary" style="width:100%; margin-bottom:0.5rem;" onclick="showScheduleModal()">
                            üìÖ Schedule Service
                        </button>
                    `;
                    break;
                case 'scheduled':
                    buttons = `
                        <button class="btn btn-primary" style="width:100%; margin-bottom:0.5rem;" onclick="startProgress()">
                            ‚ñ∂Ô∏è Start Service
                        </button>
                        <button class="btn btn-ghost" style="width:100%;" onclick="showScheduleModal()">
                            üìÖ Reschedule
                        </button>
                    `;
                    break;
                case 'in_progress':
                    buttons = `
                        <button class="btn btn-primary" style="width:100%; margin-bottom:0.5rem;" onclick="markComplete()">
                            ‚úÖ Mark as Complete
                        </button>
                        <button class="btn btn-ghost" style="width:100%;" onclick="reportIssue()">
                            ‚ö†Ô∏è Report Issue
                        </button>
                    `;
                    break;
                case 'awaiting_confirmation':
                    buttons = `
                        <button class="btn btn-ghost" style="width:100%;" onclick="reportIssue()">
                            ‚ö†Ô∏è Report Issue
                        </button>
                    `;
                    break;
                case 'completed':
                    buttons = `
                        <button class="btn btn-primary" style="width:100%; margin-bottom:0.5rem;" onclick="leaveReview()">
                            ‚≠ê Leave Review
                        </button>
                    `;
                    break;
            }

            container.innerHTML = buttons;
        }

        function renderServiceDetails() {
            const container = document.getElementById('serviceDetailsCard');
            const statusBadge = `<span class="status-badge status-${currentProgress.status}">${formatStatus(currentProgress.status)}</span>`;

            // Build need details section if this is a need service (shouldn't normally happen for offers, but handle it)
            let needDetailsHtml = '';
            if (currentService.service_type === 'need' || currentService.type === 'need') {
                const details = [];
                
                if (currentService.location_address) {
                    details.push(`<strong>üìç Location:</strong> ${currentService.location_address}`);
                }
                
                if (currentService.service_date) {
                    details.push(`<strong>üìÖ Date:</strong> ${formatDate(currentService.service_date)}`);
                }
                
                if (currentService.start_time && currentService.end_time) {
                    details.push(`<strong>üïê Time:</strong> ${currentService.start_time} - ${currentService.end_time}`);
                } else if (currentService.start_time) {
                    details.push(`<strong>üïê Start Time:</strong> ${currentService.start_time}`);
                } else if (currentService.end_time) {
                    details.push(`<strong>üïê End Time:</strong> ${currentService.end_time}`);
                }
                
                if (details.length > 0) {
                    needDetailsHtml = `
                        <div style="background: var(--bg-light); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-size: 0.875rem; color: var(--text-dark);">
                                ${details.join('<br>')}
                            </div>
                        </div>
                    `;
                }
            }

            // Build availability section for offers
            let availabilityHtml = '';
            if ((currentService.service_type === 'offer' || currentService.type === 'offer') && currentProgress.availability && currentProgress.availability.length > 0) {
                const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const availabilityMap = {};
                
                currentProgress.availability.forEach(avail => {
                    availabilityMap[avail.day_of_week] = {
                        start_time: avail.start_time.substring(0, 5), // HH:MM
                        end_time: avail.end_time.substring(0, 5)
                    };
                });
                
                const availabilityRows = daysOfWeek.map((day, index) => {
                    const dayAvail = availabilityMap[index];
                    if (dayAvail) {
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #d1fae5; border-radius: 6px; margin-bottom: 0.25rem;">
                                <span style="font-weight: 600; color: #065f46;">${day}</span>
                                <span style="color: #059669;">${dayAvail.start_time} - ${dayAvail.end_time}</span>
                            </div>
                        `;
                    }
                    return '';
                }).filter(row => row).join('');
                
                if (availabilityRows) {
                    availabilityHtml = `
                        <div style="margin-bottom: 1rem;">
                            <h3 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-dark);">üìÖ Availability</h3>
                            ${availabilityRows}
                        </div>
                    `;
                }
            }

            container.innerHTML = `
                <div class="status-header">
                    <div>
                        <h2 class="service-title" style="font-size: 1.25rem;">${currentService.title}</h2>
                        <div class="service-meta">
                            Posted ${formatDate(currentService.created_at)}
                        </div>
                    </div>
                    ${statusBadge}
                </div>
                ${needDetailsHtml}
                ${availabilityHtml}
                <p style="color: var(--text-light); margin-bottom: 1rem;">
                    ${currentService.description}
                </p>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    ${currentService.tags ? currentService.tags.split(',').map(tag => 
                        `<span class="tag">${tag.trim()}</span>`
                    ).join('') : ''}
                </div>
            `;
        }

        async function loadMessages() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/applications/${APPLICATION_ID}/messages`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const messages = await response.json();
                    renderMessages(messages);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function renderMessages(messages) {
            const thread = document.getElementById('messageThread');
            const currentUserId = JSON.parse(atob(localStorage.getItem('access_token').split('.')[1])).user_id;

            thread.innerHTML = messages.map(msg => {
                const isCurrentUser = msg.sender_id === currentUserId;
                const messageClass = isCurrentUser ? 'message current-user' : 'message other-user';

                return `
                    <div class="${messageClass}">
                        <div class="message-content">
                            <div class="message-text">${msg.message}</div>
                        </div>
                        <div class="message-time">${formatDateTime(msg.sent_at)}</div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            thread.scrollTop = thread.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/applications/${APPLICATION_ID}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                if (response.ok) {
                    input.value = '';
                    loadMessages();
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        }

        async function startProgress() {
            if (!confirm('Mark this service as "In Progress"?')) return;

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/progress/${currentProgress.id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'in_progress' })
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to update status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status');
            }
        }

        async function markComplete() {
            if (!confirm('Mark this service as complete?')) return;

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/progress/${currentProgress.id}/confirm`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to mark as complete');
                }
            } catch (error) {
                console.error('Error marking complete:', error);
                alert('Failed to mark as complete');
            }
        }

        function showScheduleModal() {
            const date = currentProgress.scheduled_date || '';
            const time = currentProgress.scheduled_time || '';
            
            const newDate = prompt('Enter scheduled date (YYYY-MM-DD):', date);
            if (!newDate) return;
            
            const newTime = prompt('Enter scheduled time (HH:MM):', time);
            if (!newTime) return;

            scheduleService(newDate, newTime);
        }

        async function scheduleService(date, time) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/progress`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        application_id: APPLICATION_ID,
                        scheduled_date: date,
                        scheduled_time: time
                    })
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to schedule service');
                }
            } catch (error) {
                console.error('Error scheduling:', error);
                alert('Failed to schedule service');
            }
        }

        function reportIssue() {
            const issue = prompt('Describe the issue:');
            if (issue) {
                alert('Issue reported (demo). This would notify admins.');
            }
        }

        function leaveReview() {
            alert('Review feature coming soon!');
        }

        function formatStatus(status) {
            const statusMap = {
                'selected': 'Selected',
                'scheduled': 'Scheduled',
                'in_progress': 'In Progress',
                'awaiting_confirmation': 'Awaiting Confirmation',
                'completed': 'Completed'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProgressData();
        });

        // Enter key to send message
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        });
    </script>
    <script src="/static/js/balance-manager.js"></script>
    <script src="/static/js/navbar.js"></script>
    <script>
        // Initialize navbar and balance manager
        document.addEventListener('DOMContentLoaded', () => {
            NavBar.init(''); // No active page since this is a progress page
            
            // Initialize balance manager with polling enabled (every 60 seconds)
            if (window.BalanceManager) {
                BalanceManager.init(true, 60);
            }
        });
    </script>
</body>
</html>
