<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services Map ‚Äî Hive</title>
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #f59e0b;
            --primary-dark: #d97706;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--bg-light);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        nav {
            background-color: var(--white);
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .nav-container {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo img {
            height: 40px;
            width: auto;
        }

        /* Page-specific styles (navigation styles are in navbar.css) */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            display: inline-block;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--text-dark);
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Map Container */
        .map-container {
            display: flex;
            height: calc(100vh - 73px);
            overflow: hidden;
        }

        /* Left Panel - Services List */
        .services-panel {
            width: 450px;
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .panel-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel-header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .panel-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Filters */
        .filters-section {
            padding: 1rem 1.5rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-tab {
            flex: 1;
            padding: 0.75rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            text-align: center;
        }

        .filter-tab.active {
            border-color: var(--primary-color);
            background: #fffbeb;
            color: var(--primary-color);
        }

        .filter-tab:hover {
            border-color: var(--primary-color);
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .results-count {
            padding: 1rem 1.5rem;
            background: #fffbeb;
            border-bottom: 1px solid #fde68a;
            font-size: 0.875rem;
            color: #92400e;
            font-weight: 500;
        }

        /* Services List */
        .services-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .service-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .service-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
            transform: translateY(-2px);
        }

        .service-card.active {
            border-color: var(--primary-color);
            background: #fffbeb;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .service-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .service-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .service-type-badge.offer {
            background: #d1fae5;
            color: #065f46;
        }

        .service-type-badge.need {
            background: #dbeafe;
            color: #1e40af;
        }

        .service-provider {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        .service-description {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 0.75rem;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .service-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        .service-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tag {
            padding: 0.25rem 0.5rem;
            background: #fef3c7;
            color: #92400e;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Right Panel - Map */
        .map-panel {
            flex: 1;
            position: relative;
            background: #e5e7eb;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state h2 {
            font-size: 1.5rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .map-container {
                flex-direction: column;
            }

            .services-panel {
                width: 100%;
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }

            .map-panel {
                height: 50vh;
            }
        }

        /* Custom Leaflet Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 200px;
        }

        .map-popup {
            padding: 1rem;
        }

        .map-popup .service-title {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .map-popup .service-type-badge {
            display: inline-block;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="/" class="logo">
                <img src="/static/hive_logo.png" alt="Hive Logo">
                <span>Hive</span>
            </a>
            
            <div id="nav-buttons">
                <!-- Navigation will be dynamically loaded based on auth state -->
            </div>
        </div>
    </nav>

    <!-- Map Container -->
    <div class="map-container">
        <!-- Left Panel: Services List -->
        <div class="services-panel">

            <!-- Filters -->
            <div class="filters-section">
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterServices('all')">All</button>
                    <button class="filter-tab" onclick="filterServices('offer')">üíº Offers</button>
                    <button class="filter-tab" onclick="filterServices('need')">üôã Needs</button>
                </div>
                <input 
                    type="text" 
                    class="search-box" 
                    placeholder="üîç Search services..." 
                    id="search-input"
                    onkeyup="searchServices()"
                >
            </div>

            <!-- Results Count -->
            <div class="results-count" id="results-count">
                Loading services...
            </div>

            <!-- Services List -->
            <div class="services-list" id="services-list">
                <div class="loading">Loading services...</div>
            </div>
        </div>

        <!-- Right Panel: Map -->
        <div class="map-panel">
            <div id="map"></div>
        </div>
    </div>

    <script src="/static/js/balance-manager.js"></script>
    <script src="/static/js/navbar.js"></script>
    <script>
        let allServices = [];
        let filteredServices = [];
        let currentFilter = 'all';
        let map;
        let markers = [];
        let selectedMarker = null;

        // Initialize map
        function initMap() {
            // Center on New York (default location, can be updated based on user location)
            map = L.map('map').setView([40.7589, -73.9851], 13);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Load services
        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    allServices = data;
                    filteredServices = allServices;
                    updateResultsCount();
                    renderServicesList();
                    addMarkersToMap();
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading services:', error);
                showEmptyState();
            }
        }

        // Filter services
        function filterServices(type) {
            currentFilter = type;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter services
            if (type === 'all') {
                filteredServices = allServices;
            } else {
                filteredServices = allServices.filter(s => s.service_type === type);
            }
            
            updateResultsCount();
            renderServicesList();
            addMarkersToMap();
        }

        // Search services
        function searchServices() {
            const query = document.getElementById('search-input').value.toLowerCase();
            
            if (query === '') {
                filteredServices = currentFilter === 'all' ? allServices : allServices.filter(s => s.service_type === currentFilter);
            } else {
                const baseServices = currentFilter === 'all' ? allServices : allServices.filter(s => s.service_type === currentFilter);
                filteredServices = baseServices.filter(service => 
                    service.title.toLowerCase().includes(query) ||
                    service.description.toLowerCase().includes(query) ||
                    service.tags.some(tag => tag.toLowerCase().includes(query))
                );
            }
            
            updateResultsCount();
            renderServicesList();
            addMarkersToMap();
        }

        // Update results count
        function updateResultsCount() {
            const countEl = document.getElementById('results-count');
            countEl.textContent = `üìä Showing ${filteredServices.length} service${filteredServices.length !== 1 ? 's' : ''}`;
        }

        // Render services list
        function renderServicesList() {
            const container = document.getElementById('services-list');
            
            if (filteredServices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No services found</h2>
                        <p>Try adjusting your filters or search query</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredServices.map(service => {
                const locationText = service.location_type === 'online' ? 'üíª Online' : 
                                    service.location_type === 'in-person' ? 'üìç In-Person' : 
                                    'üîÑ Flexible';
                
                return `
                    <div class="service-card" data-id="${service.id}" onclick="openServiceDetail(${service.id})" style="cursor: pointer;">
                        <div class="service-header">
                            <div>
                                <div class="service-title">${service.title}</div>
                                <div class="service-provider">By ${service.provider_name}</div>
                            </div>
                            <span class="service-type-badge ${service.service_type}">${service.service_type === 'offer' ? 'üíº Offer' : 'üôã Need'}</span>
                        </div>
                        <div class="service-description">${service.description}</div>
                        <div class="service-meta">
                            <span>‚è∞ ${service.duration_hours} hour${service.duration_hours > 1 ? 's' : ''}</span>
                            <span>${locationText}</span>
                        </div>
                        <div class="service-tags">
                            ${service.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add markers to map
        function addMarkersToMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add new markers
            filteredServices.forEach(service => {
                if (service.latitude && service.longitude) {
                    const markerColor = service.service_type === 'offer' ? '#10b981' : '#3b82f6';
                    const markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background: ${markerColor}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.75rem;">${service.service_type === 'offer' ? 'üíº' : 'üôã'}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });
                    
                    const marker = L.marker([service.latitude, service.longitude], { icon: markerIcon })
                        .addTo(map)
                        .bindPopup(`
                            <div class="map-popup">
                                <span class="service-type-badge ${service.service_type}">${service.service_type === 'offer' ? 'üíº Offer' : 'üôã Need'}</span>
                                <div class="service-title">${service.title}</div>
                                <div class="service-provider">By ${service.provider_name}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                                    ‚è∞ ${service.duration_hours} hour${service.duration_hours > 1 ? 's' : ''}
                                </div>
                            </div>
                        `);
                    
                    marker.serviceId = service.id;
                    marker.on('click', function() {
                        selectService(service.id);
                    });
                    
                    markers.push(marker);
                }
            });
            
            // Fit map to markers if any exist
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Open service detail page
        function openServiceDetail(serviceId) {
            window.location.href = `/service/${serviceId}`;
        }

        // Select service
        function selectService(serviceId) {
            // Remove active class from all cards
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Add active class to selected card
            const selectedCard = document.querySelector(`.service-card[data-id="${serviceId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('active');
                selectedCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // Find and open marker popup
            const marker = markers.find(m => m.serviceId === serviceId);
            if (marker) {
                map.setView(marker.getLatLng(), 15);
                marker.openPopup();
            }
        }

        // Show empty state
        function showEmptyState() {
            const container = document.getElementById('services-list');
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üêù</div>
                    <h2>No Services Yet</h2>
                    <p>Be the first to create a service!</p>
                    <a href="/create-service" class="btn btn-primary">+ Create Service</a>
                </div>
            `;
            
            document.getElementById('results-count').textContent = 'üìä Showing 0 services';
        }

        // Get URL parameters and apply search
        function applyUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('q');
            const location = urlParams.get('location');
            const dates = urlParams.get('dates');
            
            // Apply search query if present
            if (searchQuery) {
                document.getElementById('search-input').value = searchQuery;
                searchServices();
            }
            
            // TODO: Handle location and dates filters when implemented
            if (location) {
                console.log('Location filter:', location);
            }
            if (dates) {
                console.log('Dates filter:', dates);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            NavBar.init('services').then(() => {
                if (window.BalanceManager) {
                    BalanceManager.init(true, 60);
                }
            });
            initMap();
            loadServices().then(() => {
                // Apply URL parameters after services are loaded
                applyUrlParameters();
            });
        });
    </script>
</body>
</html>
